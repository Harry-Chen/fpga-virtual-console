\subsection{终端命令解析 \texttt{VT100Parser}}

对于终端的命令，我们支持VT220标准\footnote{https://vt100.net/docs/vt220-rm/}下几乎所有的会影响显示结果的命令，以及XTerm\footnote{http://invisible-island.net/xterm/ctlseqs/ctlseqs.html}下常用的光标控制以及字符编辑命令，可以支持解析绝大多数程序的输出。目前所支持的命令见表\ref{tab:supported-commands}。


\subsubsection{命令解析模块 \texttt{CommandsParser}}
命令的解析是通过如图\ref{fig:command_parser}所示的状态机来进行实现，主要在CommandsParser模块中。在解析完成一条命令后会产生一个commandsReady信号，并且附带额外的命令参数等信息以供后续模块执行对应操作。

大部分命令的参数个数以及格式均是固定的，解析较为简单。有两类特殊的命令，其参数个数不定，它们分别是控制显示字符的颜色等信息的命令，以及设置/清除终端某些状态的命令。这两类命令的参数均为零或多个由分号分隔的数字构成，参数的个数任意。

对于这两个命令的解析，我们采用另外的方法：

\begin{enumerate}
	\item 当一条命令开始时产生一个commandsReady信号并且对应INIT\_PNS命令，后续需要处理这两类命令的模块在收到此命令时重置其中状态机。
	\item 每当获取到一个参数后产生一个commandsReady信号，并且对应一个EMIT\_PNS的命令，后续需要处理这两类命令的模块在收到此命令后根据所得到的参数在其自身内部的状态机内进行处理（具体的处理方法见各模块的描述）。
	\item 当真正解析到该条命令结尾时，产生对应命令的信号，后续模块将之前所记录的信息应用到终端的状态中更新其状态。
\end{enumerate}

\begin{longtable}{|r|l|l|}
	\caption{当前支持的命令}
\label{tab:supported-commands} \\

\hline
\textbf{命令名称} & \textbf{命令格式} & \textbf{命令行为} \\ \hline
CUU & ESC [ Pn\footnote{Pn表示数值参数，可以省略} A & 光标上移\\ \hline
CUD & ESC [ Pn B & 光标下移\\ \hline
CUF & ESC [ Pn C & 光标前进\\ \hline
CUB & ESC [ Pn D & 光标后退\\ \hline
CNL & ESC [ Pn E & 光标下移到行首\\ \hline
CPL & ESC [ Pn F & 光标上移到行首\\ \hline
CHA & ESC [ Pn G & 光标水平移动\\ \hline
VPA & ESC [ Pn d & 光标垂直移动\\ \hline
CUP/HVP & ESC [ Pn; Pn f/H & 设置光标位置\\ \hline \hline

REP & ESC [ Pn b & 重复上一个输入的字符 \\ \hline
DL & ESC [ Pn M &删除行 \\ \hline
IL & ESC [ Pn L &插入行 \\ \hline
ED &ESC [ Pn J &删除部分显示的文本 \\ \hline
EL &ESC [ Pn K &删除部分当前行文本 \\ \hline
ECH & ESC [ Pn X &清除部分字符 \\ \hline
DCH & ESC [ Pn P &删除部分字符 \\ \hline
ICH & ESC [ Pn @ &插入空白字符 \\ \hline \hline

SETDEC & ESC [? Ps\footnote{Ps表示由分号分隔的个数不定的数值参数列} h & 设置DEC模式 \\ \hline
RESETDEC & ESC [? Ps l & 清除DEC模式 \\ \hline
SETMODE &ESC [ Ps h & 设置模式 \\ \hline
RESETMODE & ESC [ Ps l &清除模式 \\ \hline \hline

NEL & ESC E &新行 \\ \hline
RI & ESC M & 回到上一行 \\ \hline
IND & ESC D &转到下一行 \\ \hline
DECSC & ESC 7& 保存光标状态 \\ \hline
DECRC &ESC 8& 恢复光标状态 \\ \hline \hline

SU & ESC [ Pn S &向上滚动 \\ \hline
SD & ESC [ Pn T &向下滚动 \\ \hline
DECSTBM & ESC [ Pn; Pn r &设置滚动区域 \\ \hline \hline

SS2 & ESC N&设置字符集 \\ \hline
SS3 & ESC O&设置字符集 \\ \hline
SCS0 & ESC ( A/B/0/1/2 & 设置字符集 \\ \hline
SCS1 & ESC ) A/B/0/1/2 &设置字符集 \\ \hline \hline

SGR & ESC [ Ps m &设置颜色等字符信息 \\ \hline
\end{longtable}
\begin{figure}[htbp]
\centerline{
\includegraphics[width=0.95\paperwidth]{command_parser.pdf}
}
\caption{命令解析状态图，圆形节点为状态，方形为命令。}
\label{fig:command_parser}
\end{figure}

本模块中还初始化了下列的子模块。

\subsubsection{光标控制模块 \texttt{CursorControl}}
\subsubsection{字符控制模块 \texttt{TextControl}}
该模块负责TextRAM的读写，用于施加编辑命令产生的改变。控制整个模块功能的状态机如图\ref{fig:text_control}所示。

\begin{figure}[htbp]
\centerline{
\includegraphics[width=0.95\paperwidth]{text_control.pdf}
}
\caption{字符控制模块状态图。}
\label{fig:text_control}
\end{figure}

该模块对TextRAM的操作主要由三种基本操作组成：

\paragraph{行内编辑}
主要负责对一行内的信息进行编辑，一共分为三种编辑方法，
\begin{enumerate}
	\item 将指定行某个区间的所有字符设置成特定字符（记为A类命令）。
	\item 将指定区间的字符删除，右侧字符左移并且在空白处填充空字符（记为B类命令）。
	\item 在指定区间插入空字符，原有字符右移，若超出屏幕则丢弃（记为B类命令）。
\end{enumerate}

其状态主要为InputRead0、InputRead1、InputCycStart、InputCycRead、InputCycSet、InputWrite组成，它们的意义分别为

\begin{itemize}
	\item \textit{InputRead0.} 发送读请求，读取所需要编辑的行。
	\item \textit{InputRead1.} 等待数据到达。如果是A类命令，则直接用一个组合逻辑进行计算输出值，并且跳转到InputWrite；如果是B类命令，由于组合逻辑过于复杂，跳转到InputCycStart通过时序逻辑来完成。
	\item \textit{InputCycStart.} 将当前行的数据锁存，并且初始化后续需要的变量（当前所编辑的列，当前所需要读取的列）。
	\item \textit{InputCycRead.} 从锁存的行数据中读取当前所需要读取的列对应的字符，并存储。
	\item \textit{InputCycWrite.} 将存储的字符写入当前所编辑的列。并且更新当前列和所需要读取的列。
	\item \textit{InputWrite.} 将编辑完成的行写入。
\end{itemize}

\paragraph{屏幕滚动}
主要负责将某区域上移/下移指定行数。

该部分主要由ScrollStart、ScrollRead0、ScrollRead1和ScrollWrite组成，它们的意义分别为

\begin{itemize}
	\item \textit{ScrollStart.} 设置起始的行。
	\item \textit{ScrollRead0.} 将读请求发送给TextRAM。
	\item \textit{ScrollRead1.} 等待数据到达。
	\item \textit{ScrollWrite.} 将数据写入对应行。
\end{itemize}

\paragraph{多行清空}
主要负责将某区域填充为空字符。

该部分主要由ResetStart和ResetWrite两个状态控制。其中ResetStart负责设置起始的行，而后ResetWrite不断往下，每次向RAM中写入一个空行直到所需要清除的区域结束为止回到Idle状态。

该模块所处理的所有命令均可以通过这三种基本操作的组合构成，分别是[TODO]
\subsubsection{图形控制模块 \texttt{GraphicsControl}}
该模块主要负责处理字符的颜色和特效（下划线、闪烁、反色和增亮）。对应的命令为SGR，其参数个数不定，且共分为3种类别
\begin{enumerate}
	\item 仅用一个参数表示的属性，这部分对应于VT220的标准。
	\item 需要三个参数表示的属性，这是在一个256色的颜色表中指定对应颜色，其格式为 {\it 48/38; 5; Pn}，其中38表示前景色，48表示背景色，Pn表示颜色的编号。
	\item 需要五个参数表示的属性，这是用RGB指定颜色，其格式为 {\it 48/38; 2; R; G; B}，其中38表示前景色，48表示背景色。
\end{enumerate}

这条命令可以在一个命令内同时设置多个属性，例如{\it ESC [ 38; 5; 100; 48; 2; 0; 0; 255m}就是设置前景色为编号为100的颜色并且设置背景为蓝色。

	对应的状态机见图\ref{fig:graphics_control}，具体操作见``命令解析''中多参数命令的处理方法。
\begin{figure}[htbp]
\centerline{
\includegraphics[width=0.7\paperwidth]{graphics_control.pdf}
}
\caption{图形控制模块状态图}
\label{fig:graphics_control}
\end{figure}
\subsubsection{属性控制模块 \texttt{AttribControl}}
该模块是对滚动区域、字符集等属性设置命令的处理，较为简单，仅仅在得到命令后直接更新即可。
\subsubsection{模式控制模块 \texttt{ModeControl}}
该模块和图形控制模块同样是一个对应于多参数命令的模块，但是各个属性均可只用一个参数表示，在记录完毕所需要更新的模式后，在更新命令到来时直接更新即可。
